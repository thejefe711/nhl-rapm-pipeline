

======================================================================
RAPM VALIDATION SUITE - Season 20232024
======================================================================
======================================================================
RAPM INPUT AUDIT (vs Evolving-Hockey Methodology)
======================================================================

======================================================================
EVOLVING-HOCKEY METHODOLOGY CHECKLIST
======================================================================

Manual verification needed:
  [ ] Target variable is per-60 rate
      → Check y calculation
  [ ] Weights are stint duration in seconds
      → Check w = duration_s
  [ ] 2 rows per stint (off/def split)
      → Check obs_df length = 2 × stints
  [ ] Offense cols: +1 for offensive skaters
      → Check design matrix
  [ ] Defense cols: +1 for defensive skaters
      → Check design matrix
  [ ] Ridge regression with regularization
      → Check alpha value
  [ ] Coefficients interpreted as per-60
      → No post-hoc × 3600 if y is per-60

--- Additional Controls (Evolving-Hockey) ---
  [ ] Score state (trailing/tied/leading)
  [ ] Zone starts (OZ/NZ/DZ faceoffs)
  [ ] Back-to-back games
  Note: These improve accuracy but aren't required for basic RAPM

======================================================================
DESIGN MATRIX CHECK
======================================================================

Players in model: 508
Expected design matrix columns: 1016 (off + def per player)
✓ Same players in offensive and defensive RAPM

======================================================================
COEFFICIENT RANGE CHECK
======================================================================

Metric                                   N      Min       P5      Med     Mean      P95      Max   P5-P95
-------------------------------------------------------------------------------------------------------------------
blocked_shot_to_xg_swing_rapm_5v5_w10    508    -0.25    -0.08     0.00    -0.00     0.07     0.17        ✓
corsi_def_rapm_5v5                     508    -8.68    -2.70     0.03     0.00     2.74     6.23        ✓
corsi_off_rapm_5v5                     508    -7.29    -2.55    -0.10    -0.00     3.01     7.21        ✓
corsi_pk_def_rapm                      303   -13.90    -5.34    -0.00    -0.00     4.01     9.42        ✓
corsi_pp_off_rapm                      303    -7.76    -3.67    -0.04     0.00     4.58    12.94        ✓
corsi_rapm_5v5                         508   -15.87    -4.30    -0.10    -0.00     4.00     9.66        ✓
faceoff_loss_to_xg_swing_rapm_5v5_w10    508    -0.15    -0.07    -0.00    -0.00     0.08     0.21        ✓
finishing_residual_rapm_5v5            508    -3.20    -1.49     0.03    -0.00     1.47     3.67        ✓
giveaway_to_xg_swing_rapm_5v5_w10      508    -0.18    -0.05    -0.00    -0.00     0.05     0.15        ✓
goals_rapm_5v5                         508    -0.20    -0.10     0.00     0.00     0.10     0.23        ✓
hd_xg_def_rapm_5v5_ge020               508    -0.43    -0.17     0.01     0.00     0.13     0.34        ✓
hd_xg_off_rapm_5v5_ge020               508    -0.44    -0.14    -0.01    -0.00     0.17     0.62        ✓
hd_xg_rapm_5v5_ge020                   508    -0.79    -0.21    -0.00     0.00     0.22     0.90        ✓
penalties_drawn_rapm_5v5               508    -0.03    -0.00    -0.00     0.00     0.00     0.03        ✓
penalties_taken_rapm_5v5               508    -0.03    -0.00     0.00    -0.00     0.00     0.03        ✓
primary_assist_rapm_5v5                508    -0.20    -0.10    -0.00     0.00     0.10     0.24        ✓
secondary_assist_rapm_5v5              508    -0.22    -0.09     0.00     0.00     0.09     0.20        ✓
takeaway_to_xg_swing_rapm_5v5_w10      508    -0.10    -0.04     0.00    -0.00     0.04     0.14        ✓
turnover_to_xg_swing_rapm_5v5_w10      508    -0.17    -0.06    -0.00     0.00     0.07     0.17        ✓
xg_def_rapm_5v5                        508    -0.45    -0.17     0.01     0.00     0.14     0.36        ✓
xg_off_rapm_5v5                        508    -0.47    -0.15    -0.01    -0.00     0.17     0.64        ✓
xg_pk_def_rapm                         303    -0.45    -0.22    -0.00     0.00     0.16     0.59        ✓
xg_pp_off_rapm                         303    -0.37    -0.14    -0.00    -0.00     0.17     0.65        ✓
xg_primary_assist_on_goals_rapm_5v5    508    -0.15    -0.07     0.00    -0.00     0.07     0.14        ✓
xg_rapm_5v5                            508    -0.78    -0.22    -0.00    -0.00     0.22     0.94        ✓
xg_secondary_assist_on_goals_rapm_5v5    508    -0.16    -0.06     0.00     0.00     0.06     0.14        ✓

======================================================================
DISTRIBUTION CHECK
======================================================================

Offensive xG RAPM:
  N:      508
  Mean:   -0.0000 (should be ~0)
  Median: -0.0075
  Std:    0.1102
  Skew:   1.1730 (should be ~0)

Defensive xG RAPM:
  N:      508
  Mean:   0.0000 (should be ~0)
  Median: 0.0107
  Std:    0.0965
  Skew:   -0.3118 (should be ~0)

--- Validation ---
  Off mean ~0: ✓ PASS (value: -0.0000)
  Def mean ~0: ✓ PASS (value: 0.0000)
  Off skew reasonable: ✗ FAIL (value: 1.1730)
  Def skew reasonable: ✓ PASS (value: -0.3118)

======================================================================
CORRELATION CHECK
======================================================================

Correlation Matrix:

                         si_def_rapm_5v5si_off_rapm_5v5 goals_rapm_5v5xg_def_rapm_5v5xg_off_rapm_5v5
       corsi_def_rapm_5v5          1.000          0.265         -0.077          0.737          0.212
       corsi_off_rapm_5v5          0.265          1.000         -0.063          0.195          0.748
           goals_rapm_5v5         -0.077         -0.063          1.000          0.135         -0.108
          xg_def_rapm_5v5          0.737          0.195          0.135          1.000          0.158
          xg_off_rapm_5v5          0.212          0.748         -0.108          0.158          1.000

--- Expected Correlations ---
  xG_off vs Corsi_off: 0.5 to 0.8 (should be related)
  xG_off vs xG_def: -0.3 to 0.3 (weak correlation)
  xG_off vs Goals: 0.3 to 0.6 (xG predicts goals)

======================================================================
KNOWN PLAYERS SPOT CHECK
======================================================================

Player                        Off     Def   Total    Off%    Def%    Tot%    TOI
-----------------------------------------------------------------------------------------------
Connor McDavid               0.38    0.16    0.54     99%      4%     99%    255
Nathan MacKinnon          NOT FOUND
Nikita Kucherov              0.05   -0.04    0.01     77%     73%     55%     51
Auston Matthews              0.17    0.05    0.23     95%     24%     95%    256
Leon Draisaitl               0.55    0.11    0.66    100%      7%    100%    286
Cale Makar                NOT FOUND
Quinn Hughes                -0.10   -0.10   -0.19     12%     87%      8%     75
Adam Fox                     0.22    0.11    0.33     97%      7%     97%    151

--- Validation ---
  Elite players should be >80th percentile in total RAPM

======================================================================
FINAL VALIDATION (min 200 min TOI)
======================================================================

Players included: 35

--- Coefficient Ranges ---
xG Off: -0.30 to 0.64
xG Def: -0.28 to 0.36
Total:  -0.31 to 0.93

--- Top 10 Total xG RAPM ---
Evan Bouchard             Off:   0.64  Def:   0.29  Total:   0.93  TOI:   294
Warren Foegele            Off:   0.41  Def:   0.27  Total:   0.68  TOI:   216
Leon Draisaitl            Off:   0.55  Def:   0.11  Total:   0.66  TOI:   286
Mattias Ekholm            Off:   0.48  Def:   0.18  Total:   0.66  TOI:   275
Erik Gustafsson           Off:   0.18  Def:   0.36  Total:   0.54  TOI:   282
Connor McDavid            Off:   0.38  Def:   0.16  Total:   0.54  TOI:   255
Tyler Bertuzzi            Off:   0.29  Def:   0.21  Total:   0.50  TOI:   246
Alexis Lafrenière         Off:   0.13  Def:   0.36  Total:   0.49  TOI:   260
William Nylander          Off:   0.22  Def:   0.21  Total:   0.44  TOI:   245
John Tavares              Off:   0.33  Def:   0.10  Total:   0.43  TOI:   244

--- Bottom 10 Total xG RAPM ---
Matthew Knies             Off:  -0.03  Def:  -0.07  Total:  -0.10  TOI:   214
Darnell Nurse             Off:   0.16  Def:  -0.27  Total:  -0.10  TOI:   311
Evander Kane              Off:   0.14  Def:  -0.26  Total:  -0.12  TOI:   262
Mark Giordano             Off:   0.04  Def:  -0.20  Total:  -0.16  TOI:   256
Braden Schneider          Off:  -0.15  Def:  -0.06  Total:  -0.21  TOI:   248
John Klingberg            Off:  -0.03  Def:  -0.20  Total:  -0.22  TOI:   228
Jacob Trouba              Off:  -0.21  Def:  -0.03  Total:  -0.24  TOI:   329
Blake Wheeler             Off:   0.02  Def:  -0.28  Total:  -0.27  TOI:   205
K'Andre Miller            Off:  -0.30  Def:   0.04  Total:  -0.27  TOI:   331
Calle Jarnkrok            Off:  -0.29  Def:  -0.01  Total:  -0.31  TOI:   212

--- Distribution ---
Mean Off:  0.1299
Mean Def:  0.0525
Std Off:   0.2515
Std Def:   0.1979

Off/Def correlation: 0.028 (expected: -0.3 to +0.3)

--- Validation Summary ---
  Coefficient range OK: ✓ PASS
  Mean centered near 0: ✗ FAIL
  Off/Def correlation reasonable: ✓ PASS


======================================================================
VALIDATION COMPLETE
======================================================================

✗ Some validation checks failed - review output above

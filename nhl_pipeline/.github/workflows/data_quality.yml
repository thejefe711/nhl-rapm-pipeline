name: Data Quality Gates

on:
  push:
    paths:
      - 'nhl_pipeline/src/pipeline/**'
      - 'nhl_pipeline/src/models/**'
      - 'nhl_pipeline/src/validation/**'
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest duckdb pandas scikit-learn numpy requests
      - name: Run unit tests
        run: pytest nhl_pipeline/tests/unit -v --tb=short
      
  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest duckdb pandas scikit-learn numpy requests
      - name: Run integration tests
        run: pytest nhl_pipeline/tests/integration -v --tb=short
  
  golden-file-tests:
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest duckdb pandas scikit-learn numpy requests
      - name: Run golden file comparisons
        run: pytest nhl_pipeline/tests/golden -v --tb=short
  
  data-validation:
    runs-on: ubuntu-latest
    needs: golden-file-tests
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest duckdb pandas scikit-learn numpy requests
      
      # Note: This step assumes the DB is available or can be built/downloaded
      # For now, we just show the command structure
      - name: Run full data validation suite
        run: |
          # python -m nhl_pipeline.src.validation.run_all_validations --season 2024
          echo "Skipping actual run as DB is not present in CI env"
      
      - name: Check validation results
        run: |
          if [ -f validation_report.json ]; then
            FAILURES=$(cat validation_report.json | jq '.failures | length')
            if [ "$FAILURES" -gt 0 ]; then
              echo "Data validation failed with $FAILURES issues"
              cat validation_report.json | jq '.failures'
              exit 1
            fi
          fi
